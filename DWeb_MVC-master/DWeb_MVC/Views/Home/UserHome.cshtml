@model List<DWeb_MVC.Models.Produtos>

@{
    ViewData["Title"] = "Página Inicial";
    Layout = "~/Views/Shared/_LayoutPublic.cshtml";
}

@{
    var gruposComCategorias = Model
        .SelectMany(p => p.Categoria)
        .Where(c => c.Grupos != null)
        .GroupBy(c => c.Grupos.Nome)
        .ToDictionary(g => g.Key, g => g.Select(c => c.Nome).Distinct().ToList());
}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">GOLD STIRRUP</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarGrupos" aria-controls="navbarGrupos" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarGrupos">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">

                @foreach (var grupo in gruposComCategorias)
                {
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-capitalize" href="#" id="navbarDropdown_@grupo.Key" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            @grupo.Key
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown_@grupo.Key">
                            @foreach (var categoria in grupo.Value)
                            {
                                <li>
                                    <a class="dropdown-item"
                                       asp-controller="Home"
                                       asp-action="ProdutosPorCategoria"
                                       asp-route-categoria="@categoria">
                                        @categoria
                                    </a>
                                </li>
                            }
                        </ul>
                    </li>
                }

            </ul>
        </div>
    </div>
</nav>


<div id="hero-section">
    <div id="carouselLoja" class="carousel slide" data-bs-ride="carousel" data-bs-interval="9000">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="~/imagens/carrosel/LogoGoldStirrup.png" alt="Imagem 1">
            </div>
            <div class="carousel-item">
                <img src="~/imagens/carrosel/CarrosselImage2.png" alt="Imagem 2">
            </div>
        </div>

        <button class="carousel-control-prev" type="button" data-bs-target="#carouselLoja" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
            <span class="visually-hidden">Anterior</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselLoja" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
            <span class="visually-hidden">Seguinte</span>
        </button>
    </div>
</div>

@foreach (var grupoNome in Model
    .SelectMany(p => p.Categoria)
    .Where(c => c.Grupos != null)
    .Select(c => c.Grupos.Nome)
    .Distinct()
    .OrderBy(n => n))
{
    <section class="categoria-bloco my-5 py-4 px-3 bg-white shadow rounded">
        <div class="container">
            <h2 class="mb-3">@grupoNome</h2>
            <p class="mb-4 text-muted">
                @(grupoNome == "Cavalo" ? "Na equitação a relação entre cavalo e cavaleiro é essencial..."
                            : grupoNome == "Cavaleiro" ? "Proteja-se com conforto e elegância."
                            : "Organização, higiene e bem-estar para o seu cavalo.")
        </p>

            <div class="row">
            @foreach (var produto in Model
                        .Where(p => p.Categoria.Any(c => c.Grupos != null && c.Grupos.Nome == grupoNome))
                        .OrderBy(p => Guid.NewGuid())
                        .Take(3))
                {
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 produto-card"
                             data-bs-toggle="modal"
                             data-bs-target="#produtoModal"
                             data-nome="@produto.Nome"
                             data-marca="@produto.Marca"
                             data-preco="@produto.Preco.ToString("C")"
                             data-categoria="@string.Join(", ", produto.Categoria.Select(c => c.Nome))"
                             data-imagem="~/imagens/@(produto.Fotos.FirstOrDefault()?.NomeFicheiro ?? "noProduto.jpg")">
                            <img src="~/imagens/@(produto.Fotos.FirstOrDefault()?.NomeFicheiro ?? "noProduto.jpg")" class="card-img-top" alt="@produto.Nome" />
                            <div class="card-body">
                                <h5 class="card-title">@produto.Nome</h5>
                                <p class="card-text">@produto.Marca</p>
                                <p class="card-text"><strong>@produto.Preco.ToString("C")</strong></p>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="text-center mt-3">
                <a asp-action="ProdutosPorGrupo" asp-controller="Home" asp-route-grupo="@grupoNome"
                   class="btn btn-outline-primary">
                    Ver todos os Produtos
                </a>
            </div>
        </div>
    </section>
}

<!-- pop up produto -->
<div class="modal fade" id="produtoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #3a250e; color: #fff;">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Produto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImagem" src="" alt="Imagem Produto" class="img-fluid mb-3" />
                <p><strong>Nome:</strong> <span id="modalNome"></span></p>
                <p><strong>Marca:</strong> <span id="modalMarca"></span></p>
                <p><strong>Preço:</strong> <span id="modalPreco"></span></p>
                <p><strong>Categoria:</strong> <span id="modalCategoria"></span></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>
</div>

<script>
    const produtoModal = document.getElementById('produtoModal');
    produtoModal.addEventListener('show.bs.modal', function (event) {
        const card = event.relatedTarget;

        const nome = card.getAttribute('data-nome');
        const marca = card.getAttribute('data-marca');
        const preco = card.getAttribute('data-preco');
        const categoria = card.getAttribute('data-categoria');
        const imagem = card.getAttribute('data-imagem').replace('~', '');

        document.getElementById('modalNome').textContent = nome;
        document.getElementById('modalMarca').textContent = marca;
        document.getElementById('modalPreco').textContent = preco;
        document.getElementById('modalCategoria').textContent = categoria;
        document.getElementById('modalImagem').src = imagem;
    });
</script>
